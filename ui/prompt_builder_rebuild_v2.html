<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interior Prompt Builder v2.4</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --line:#2a2f3a; --text:#e9edf5; --muted:#a4adbd; --accent:#7aa2ff; --ok:#19c37d; --bad:#ff5d6c; --off:#657089; }
    * { box-sizing:border-box; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    header { padding:14px 18px; border-bottom:1px solid var(--line); }
    h1 { margin:0; font-size:18px; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; }
    .wrap { display:grid; grid-template-columns:minmax(700px,1.6fr) minmax(420px,1fr); gap:12px; padding:12px; min-height:calc(100vh - 56px); }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto; }
    .controls-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .sec { border:1px solid var(--line); border-radius:10px; padding:10px; }
    .sec h3 { margin:0 0 8px; font-size:13px; }
    label { display:block; color:var(--muted); font-size:12px; margin:8px 0 6px; }
    button, textarea { width:100%; background:#12151b; color:var(--text); border:1px solid #303747; border-radius:8px; padding:8px; font-size:13px; }
    button { cursor:pointer; }
    button:hover { border-color:var(--accent); }
    .seg { display:grid; gap:6px; grid-template-columns:repeat(3,minmax(0,1fr)); }
    .seg.seg-2 { grid-template-columns:repeat(2,minmax(0,1fr)); }
    .seg.seg-4 { grid-template-columns:repeat(4,minmax(0,1fr)); }
    .seg button.active { background:#1e2d4d; border-color:#5c7ecf; }
    .seg button.off { border-color:#3c4457; color:var(--off); background:#141922; cursor:not-allowed; }
    .hint { color:var(--muted); font-size:11px; margin-top:6px; }
    .placement-head { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .placement-head small { color:var(--muted); font-size:11px; }
    .camera-row { display:grid; grid-template-columns:180px 1fr; gap:10px; }
    .angle-pad-wrap { border:1px solid #33405a; border-radius:10px; background:#121826; padding:8px; }
    .angle-pad { position:relative; width:100%; aspect-ratio:1/1; border:1px solid #3b4b6f; border-radius:8px; background:linear-gradient(to right, transparent 49.5%, #42557f 49.5%, #42557f 50.5%, transparent 50.5%), linear-gradient(to bottom, transparent 49.5%, #42557f 49.5%, #42557f 50.5%, transparent 50.5%), #0f1522; cursor:crosshair; }
    .angle-marker { position:absolute; width:12px; height:12px; border-radius:50%; border:2px solid #dce8ff; background:#7aa2ff; transform:translate(-50%,-50%); box-shadow:0 0 0 3px rgba(122,162,255,.2); pointer-events:none; }
    .btns3 { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    textarea { min-height:70px; resize:vertical; }
    pre { white-space:pre-wrap; word-break:break-word; background:#11141a; border:1px solid #2b3342; border-radius:8px; padding:10px; min-height:360px; font-size:12px; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip { padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid #39445d; background:#151c2b; }
    .chip.ok { border-color:#1f5a43; color:#96f0c8; }
    .chip.bad { border-color:#6d2b35; color:#ffadb7; }
    .status { color:var(--muted); font-size:12px; margin-top:8px; }
    @media (max-width: 1200px) { .wrap, .controls-grid, .camera-row { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Interior Prompt Builder v2.4</h1>
    <div class="meta">Left: option controls · Right: prompt generation and preview</div>
  </header>

  <div class="wrap">
    <section class="panel">
      <div class="controls-grid">
        <div class="sec">
          <h3>Space Setup</h3>
          <label>Space Type</label>
          <div id="spaceSeg" class="seg seg-4"></div>

          <div class="placement-head" style="margin-top:8px;">
            <label style="margin:0;">Placement in Space</label>
            <small id="placementContext"></small>
          </div>
          <div id="placementSeg" class="seg seg-2"></div>
          <div class="hint">Unavailable placements stay visible and are dimmed.</div>

          <label>Support Scale</label>
          <div id="scaleSeg" class="seg seg-4"></div>
          <div id="scaleHint" class="hint"></div>
        </div>

        <div class="sec">
          <h3>Style Setup</h3>
          <label>Style Preset</label>
          <div id="styleSeg" class="seg seg-2"></div>

          <label>Time of Day</label>
          <div id="timeSeg" class="seg seg-3"></div>

          <label>Decor Density</label>
          <div id="densitySeg" class="seg seg-3"></div>

          <label>Shot Distance</label>
          <div id="distanceSeg" class="seg seg-3"></div>

          <label>Lens Type</label>
          <div id="lensSeg" class="seg seg-3"></div>
        </div>

        <div class="sec" style="grid-column:1/-1;">
          <h3>Camera</h3>
          <div class="camera-row">
            <div class="angle-pad-wrap">
              <div id="anglePad" class="angle-pad"><div id="angleMarker" class="angle-marker"></div></div>
              <div id="angleReadout" class="hint">Angle: three-quarter, eye-level</div>
            </div>
            <div>
              <label>Quick Angle Presets</label>
              <div id="anglePresetSeg" class="seg seg-3"></div>

              <label>Clearance Guidance</label>
              <textarea id="keepout">clear perimeter around hero subject</textarea>

              <label>Scene Intent</label>
              <textarea id="intent">composition prepared for later object compositing</textarea>
            </div>
          </div>
        </div>

        <div class="sec">
          <h3>Anchor Zone</h3>
          <div id="anchorSeg" class="seg seg-2"></div>
        </div>

        <div class="sec">
          <h3>Layout Cue</h3>
          <div id="layoutSeg" class="seg seg-2"></div>
        </div>
      </div>

      <div class="btns3">
        <button id="saveBtn" type="button">Save Preset</button>
        <button id="loadBtn" type="button">Load Preset</button>
        <button id="resetBtn" type="button">Reset</button>
      </div>
      <div id="status" class="status"></div>
    </section>

    <section class="panel">
      <h3>Generated Prompt</h3>
      <div class="btns3" style="margin-top:0;margin-bottom:8px;">
        <button id="generateBtn" type="button">Generate Prompt</button>
        <button id="copyBtn" type="button">Copy Prompt</button>
        <button id="exportBtn" type="button">Export Session Log</button>
      </div>
      <pre id="promptView"></pre>
      <div id="checks" class="chips"></div>
    </section>
  </div>

<script>
const SPACE_OPTIONS = [
  { id:'living room', label:'Living Room' },
  { id:'bedroom', label:'Bedroom' },
  { id:'dining area', label:'Dining Area' },
  { id:'kitchen', label:'Kitchen' },
  { id:'home office', label:'Home Office' },
  { id:'entryway', label:'Entryway' },
  { id:'home outdoor', label:'Home Outdoor' }
];

const PLACEMENT_OPTIONS_BY_SPACE = {
  'living room': ['Beside sofa', 'On side table', 'On media console', 'On floating shelf', 'By window bench', 'At rug edge'],
  'bedroom': ['On nightstand', 'On dresser top', 'On bedside shelf', 'At bed-end bench', 'By curtain side'],
  'dining area': ['At table center', 'On sideboard', 'On wall shelf', 'At dining corner'],
  'kitchen': ['On kitchen island', 'On counter corner', 'On breakfast bar', 'On open shelf'],
  'home office': ['On desk corner', 'On side credenza', 'On bookshelf', 'By reading chair'],
  'entryway': ['On entry console', 'On shoe cabinet top', 'On hallway niche shelf', 'By entry bench'],
  'home outdoor': ['On patio table', 'On terrace console', 'By balcony railing', 'By outdoor lounge chair', 'On deck side table', 'At garden seating edge']
};

const ALL_PLACEMENTS = [...new Set(Object.values(PLACEMENT_OPTIONS_BY_SPACE).flat())];
const TIME_OPTIONS = ['Daytime', 'Golden Hour', 'Evening'];
const DENSITY_OPTIONS = ['Low', 'Medium', 'High'];
const DISTANCE_OPTIONS = ['Wide shot', 'Medium shot', 'Close shot'];
const LENS_OPTIONS = [
  { id:'wide', label:'Wide (16–28mm)', cue:'wide-angle perspective' },
  { id:'standard', label:'Standard (35–50mm)', cue:'natural perspective' },
  { id:'tele', label:'Telephoto (70–100mm)', cue:'compressed perspective' }
];
const ANGLE_PRESETS = [
  { id:'frontal-eye', label:'Frontal Eye-level', pitch:8, yaw:0 },
  { id:'threequarter-eye', label:'3/4 Eye-level', pitch:10, yaw:32 },
  { id:'threequarter-elevated', label:'3/4 Elevated', pitch:26, yaw:34 },
  { id:'threequarter-low', label:'3/4 Low Angle', pitch:-4, yaw:24 },
  { id:'side-view', label:'Side View', pitch:8, yaw:64 },
  { id:'soft-top', label:'Soft Top-down', pitch:36, yaw:16 }
];
const ANCHOR_OPTIONS = [
  { id:'center-clear', label:'Center Clear', cue:'keep central negative space for subject readability' },
  { id:'right-third-clear', label:'Right-third Clear', cue:'maintain clear negative space in the right third' },
  { id:'left-third-clear', label:'Left-third Clear', cue:'maintain clear negative space in the left third' },
  { id:'foreground-clear', label:'Foreground Clear', cue:'keep foreground uncluttered for stronger depth separation' }
];
const LAYOUT_OPTIONS = [
  { id:'balanced-symmetry', label:'Balanced Symmetry', cue:'use a balanced symmetrical composition with stable vertical lines' },
  { id:'balanced-asymmetry', label:'Balanced Asymmetry', cue:'use a balanced asymmetrical composition with intentional visual weight' },
  { id:'depth-layering', label:'Depth Layering', cue:'emphasize foreground, midground, and background layering' },
  { id:'open-flow', label:'Open Flow', cue:'keep circulation lines readable and spatial flow unobstructed' }
];

const state = {
  lexicon: null,
  values: {
    space: 'living room',
    placement: 'Beside sofa',
    stylePreset: '',
    time: 'Daytime',
    density: 'Medium',
    distance: 'Medium shot',
    lens: 'wide',
    scaleIndex: 1,
    pitch: 20,
    yaw: 30,
    anchor: 'right-third-clear',
    layout: 'balanced-asymmetry'
  },
  logs: []
};

const $ = (id) => document.getElementById(id);
function stripQuote(v){ return (v || '').replace(/^"|"$/g, '').trim(); }

function parseSceneDnaYml(text){
  const out = {}; let preset = null;
  text.split('\n').forEach((line)=>{
    if (/^\s{2}[a-z_]+:$/.test(line)) { preset = line.trim().slice(0,-1); out[preset] = {}; return; }
    if (/^\s{4}[a-z_]+: /.test(line) && preset) {
      const idx=line.indexOf(':');
      const key=line.trim().slice(0,line.trim().indexOf(':'));
      out[preset][key]=stripQuote(line.slice(idx+1));
    }
  });
  return out;
}

function parseScaleBucketsYml(text){
  const out=[]; let item=null;
  text.split('\n').forEach((line)=>{
    if (/^\s{2}- id: /.test(line)) { item={id:line.split(':').slice(1).join(':').trim()}; out.push(item); return; }
    if (!item) return;
    if (/^\s{4}surface_prompt: /.test(line)) item.surface_prompt=stripQuote(line.split(':').slice(1).join(':'));
  });
  return out;
}

async function loadLexicons(){
  const [dnaText, scaleText] = await Promise.all([
    fetch('../lexicon/scene_dna.yml').then(r=>r.text()),
    fetch('../lexicon/scale_buckets.yml').then(r=>r.text())
  ]);
  state.lexicon = {
    stylePresets: parseSceneDnaYml(dnaText).scene_dna || parseSceneDnaYml(dnaText),
    scales: parseScaleBucketsYml(scaleText)
  };
}

function nicePresetLabel(key){
  return key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

function renderSegment(rootId, items, selected, onSelect, getId=(x)=>x, getLabel=(x)=>x){
  const root = $(rootId);
  root.innerHTML = '';
  items.forEach((item)=>{
    const id = getId(item);
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.dataset.value = id;
    btn.textContent = getLabel(item);
    if (id === selected) btn.classList.add('active');
    btn.addEventListener('click', () => onSelect(id));
    root.appendChild(btn);
  });
}

function renderSpace(){
  renderSegment('spaceSeg', SPACE_OPTIONS, state.values.space, (id)=>{ state.values.space = id; renderPlacement(); renderSpace(); }, x=>x.id, x=>x.label);
}

function renderPlacement(){
  const allowed = new Set(PLACEMENT_OPTIONS_BY_SPACE[state.values.space] || []);
  if (!allowed.has(state.values.placement)) state.values.placement = [...allowed][0] || ALL_PLACEMENTS[0];

  $('placementContext').textContent = `For ${SPACE_OPTIONS.find(x=>x.id===state.values.space)?.label || ''}`;
  const root = $('placementSeg');
  root.innerHTML = '';
  ALL_PLACEMENTS.forEach((name)=>{
    const btn = document.createElement('button');
    const enabled = allowed.has(name);
    btn.type = 'button';
    btn.textContent = name;
    btn.dataset.value = name;
    if (!enabled) { btn.disabled = true; btn.classList.add('off'); }
    if (state.values.placement === name) btn.classList.add('active');
    btn.addEventListener('click', ()=>{
      if (!enabled) return;
      state.values.placement = name;
      renderPlacement();
    });
    root.appendChild(btn);
  });
}

function renderScale(){
  const items = state.lexicon.scales.map((s,i)=>({id:i,label:s.id.replaceAll('_',' ')}));
  renderSegment('scaleSeg', items, state.values.scaleIndex, (id)=>{ state.values.scaleIndex = Number(id); renderScale(); updateScaleHint(); }, x=>x.id, x=>x.label);
}

function updateScaleHint(){
  $('scaleHint').textContent = state.lexicon.scales[state.values.scaleIndex]?.surface_prompt || '';
}

function renderStyle(){
  const keys = Object.keys(state.lexicon.stylePresets);
  if (!state.values.stylePreset) state.values.stylePreset = keys[0];
  renderSegment('styleSeg', keys, state.values.stylePreset, (id)=>{ state.values.stylePreset = id; renderStyle(); }, x=>x, x=>nicePresetLabel(x));
}

function renderSimpleSegments(){
  renderSegment('timeSeg', TIME_OPTIONS, state.values.time, (id)=>{ state.values.time = id; renderSimpleSegments(); });
  renderSegment('densitySeg', DENSITY_OPTIONS, state.values.density, (id)=>{ state.values.density = id; renderSimpleSegments(); });
  renderSegment('distanceSeg', DISTANCE_OPTIONS, state.values.distance, (id)=>{ state.values.distance = id; renderSimpleSegments(); });
  renderSegment('lensSeg', LENS_OPTIONS, state.values.lens, (id)=>{ state.values.lens = id; renderSimpleSegments(); }, x=>x.id, x=>x.label);
  renderSegment('anchorSeg', ANCHOR_OPTIONS, state.values.anchor, (id)=>{ state.values.anchor = id; renderSimpleSegments(); }, x=>x.id, x=>x.label);
  renderSegment('layoutSeg', LAYOUT_OPTIONS, state.values.layout, (id)=>{ state.values.layout = id; renderSimpleSegments(); }, x=>x.id, x=>x.label);
  renderSegment('anglePresetSeg', ANGLE_PRESETS, null, (id)=>{ applyAnglePreset(id); }, x=>x.id, x=>x.label);
}

function applyAnglePreset(id){
  const preset = ANGLE_PRESETS.find(x=>x.id===id);
  if (!preset) return;
  setPitchYaw(preset.pitch, preset.yaw);
}

function setPitchYaw(pitch,yaw){
  state.values.pitch = Math.round(Math.max(-20, Math.min(60, pitch)));
  state.values.yaw = Math.round(Math.max(-90, Math.min(90, yaw)));
  updateAngleUI();
}

function updateAngleUI(){
  const x = ((state.values.yaw + 90) / 180) * 100;
  const y = 100 - ((state.values.pitch + 20) / 80) * 100;
  $('angleMarker').style.left = `${Math.max(0,Math.min(100,x))}%`;
  $('angleMarker').style.top = `${Math.max(0,Math.min(100,y))}%`;

  const viewLabel = Math.abs(state.values.yaw) < 12 ? 'frontal' : Math.abs(state.values.yaw) < 48 ? 'three-quarter' : 'side-oriented';
  const levelLabel = state.values.pitch >= 28 ? 'slightly elevated' : state.values.pitch <= 0 ? 'slightly low-angle' : 'eye-level';
  $('angleReadout').textContent = `Angle: ${viewLabel}, ${levelLabel}`;
}

function cameraOrientationCue(){
  const y = Math.abs(state.values.yaw);
  const p = state.values.pitch;
  const orientation = y < 12 ? 'frontal composition' : y < 48 ? 'three-quarter composition' : 'side-oriented composition';
  const elevation = p >= 28 ? 'slightly elevated view' : p <= 0 ? 'slightly low-angle view' : 'eye-level view';
  return `${elevation}, ${orientation}`;
}

function compilePrompt(){
  const preset = state.lexicon.stylePresets[state.values.stylePreset];
  const lens = LENS_OPTIONS.find(x=>x.id===state.values.lens);
  const anchor = ANCHOR_OPTIONS.find(x=>x.id===state.values.anchor);
  const layout = LAYOUT_OPTIONS.find(x=>x.id===state.values.layout);
  const scale = state.lexicon.scales[state.values.scaleIndex];

  return [
    `${state.values.space} interior scene`,
    `${state.values.time.toLowerCase()} lighting`,
    `placement: ${state.values.placement}`,
    `decor density: ${state.values.density.toLowerCase()}`,
    `shot distance: ${state.values.distance.toLowerCase()}`,
    `camera perspective: ${lens.cue}`,
    `camera orientation: ${cameraOrientationCue()}`,
    `color palette: ${preset.palette}`,
    `materials: ${preset.materials}`,
    `lighting style: ${preset.lighting}`,
    `tone and grading: ${preset.grading}`,
    `photography mood: ${preset.photography_vibe}`,
    `anchor guidance: ${anchor.cue}`,
    `layout guidance: ${layout.cue}`,
    `support scale: ${scale.surface_prompt}`,
    `clearance: ${$('keepout').value.trim()}`,
    `scene intent: ${$('intent').value.trim()}`
  ].join(', ')
    .replace(/\bproducts\b/gi,'subjects')
    .replace(/\bproduct\b/gi,'subject');
}

function generate(){
  const prompt = compilePrompt();
  $('promptView').textContent = prompt;

  const checks = [
    { ok: !/\bpitch\b|\byaw\b|°/i.test(prompt), msg:'No raw degree tokens in prompt' },
    { ok: prompt.includes('camera orientation:') && prompt.includes('camera perspective:'), msg:'Camera language is model-friendly' },
    { ok: prompt.includes('anchor guidance:') && prompt.includes('layout guidance:'), msg:'Anchor and layout are explicit cues' }
  ];
  $('checks').innerHTML = '';
  checks.forEach((c)=>{
    const d = document.createElement('div');
    d.className = `chip ${c.ok ? 'ok' : 'bad'}`;
    d.textContent = `${c.ok ? 'PASS' : 'CHECK'} · ${c.msg}`;
    $('checks').appendChild(d);
  });

  state.logs.push({ ts:new Date().toISOString(), space:state.values.space, placement:state.values.placement, lens:state.values.lens });
  $('status').textContent = 'Prompt generated successfully.';
}

function savePreset(){
  localStorage.setItem('prompt_builder_rebuild_v2_preset', JSON.stringify({ values: state.values, keepout:$('keepout').value, intent:$('intent').value }));
  $('status').textContent = 'Preset saved.';
}

function loadPreset(){
  const raw = localStorage.getItem('prompt_builder_rebuild_v2_preset');
  if (!raw) { $('status').textContent = 'No preset found.'; return; }
  try {
    const data = JSON.parse(raw);
    state.values = { ...state.values, ...(data.values || {}) };
    $('keepout').value = data.keepout || $('keepout').value;
    $('intent').value = data.intent || $('intent').value;
    renderAll();
    generate();
    $('status').textContent = 'Preset loaded.';
  } catch {
    $('status').textContent = 'Preset data is invalid.';
  }
}

function resetForm(){
  const firstPreset = Object.keys(state.lexicon.stylePresets)[0];
  state.values = {
    space:'living room', placement:'Beside sofa', stylePreset:firstPreset,
    time:'Daytime', density:'Medium', distance:'Medium shot', lens:'wide',
    scaleIndex:1, pitch:20, yaw:30, anchor:'right-third-clear', layout:'balanced-asymmetry'
  };
  $('keepout').value = 'clear perimeter around hero subject';
  $('intent').value = 'composition prepared for later object compositing';
  renderAll();
  $('promptView').textContent = '';
  $('checks').innerHTML = '';
  $('status').textContent = 'Form reset complete.';
}

function copyPrompt(){
  const text = $('promptView').textContent;
  if (!text) { $('status').textContent = 'Generate a prompt first.'; return; }
  navigator.clipboard.writeText(text)
    .then(()=> { $('status').textContent = 'Prompt copied.'; })
    .catch(()=> { $('status').textContent = 'Clipboard copy failed.'; });
}

function exportLog(){
  const lines = ['# Session Log', '', ...state.logs.map((x,i)=>`- ${i+1}. ${x.ts} | space=${x.space} | placement=${x.placement} | lens=${x.lens}`)];
  const blob = new Blob([lines.join('\n')], {type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'session_log.md';
  a.click();
  URL.revokeObjectURL(a.href);
  $('status').textContent = 'Session log exported.';
}

function bind(){
  $('generateBtn').addEventListener('click', generate);
  $('copyBtn').addEventListener('click', copyPrompt);
  $('exportBtn').addEventListener('click', exportLog);
  $('saveBtn').addEventListener('click', savePreset);
  $('loadBtn').addEventListener('click', loadPreset);
  $('resetBtn').addEventListener('click', resetForm);

  const pad = $('anglePad');
  let dragging = false;
  const fromPointer = (evt) => {
    const rect = pad.getBoundingClientRect();
    const nx = Math.max(0, Math.min(1, (evt.clientX - rect.left) / rect.width));
    const ny = Math.max(0, Math.min(1, (evt.clientY - rect.top) / rect.height));
    setPitchYaw(((1 - ny) * 80) - 20, (nx * 180) - 90);
  };
  pad.addEventListener('pointerdown', (evt)=>{ dragging = true; fromPointer(evt); pad.setPointerCapture(evt.pointerId); });
  pad.addEventListener('pointermove', (evt)=>{ if (!dragging) return; fromPointer(evt); });
  pad.addEventListener('pointerup', ()=>{ dragging = false; });
}

function renderAll(){
  renderSpace();
  renderPlacement();
  renderScale();
  renderStyle();
  renderSimpleSegments();
  updateScaleHint();
  updateAngleUI();
}

(async function init(){
  await loadLexicons();
  state.values.stylePreset = Object.keys(state.lexicon.stylePresets)[0];
  bind();
  renderAll();
})();
</script>
</body>
</html>
